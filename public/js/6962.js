"use strict";(self.webpackChunkdovotori=self.webpackChunkdovotori||[]).push([[6962],{20446(e,t,r){r.d(t,{A:()=>s});var i=r(65304);class s{constructor(e,t){this.context=e,this.config=t,this.time=0}async setupAssets(e){const t=this.context.getDevice();return{programs:Object.keys(e.shaders).reduce(((r,s)=>{const n=new i.A;return n.setup(t,s,e.shaders[s]),r[s]=n,r}),{})}}destroy(){}resize(){}update(){this.time++}render(){}}},56962(e,t,r){r.r(t),r.d(t,{default:()=>d,destroy:()=>h});var i=r(99590);const s={slug:"fish",shaders:["/wgsl/fragment/f_fish.js","/wgsl/vertex/v_fish.js"],canvas:{width:1024,height:1024},useWebGpu:!0};var n=r(20446);class o{constructor(e){this._computeShader=e}static async init(e){const t=new o(e);return await t._initWebGPU(),await t._initComputePipeline(),t}run(e,t,r,i){if(!this._device||!this._computePipeline)return;this._commandEncoder=this._device.createCommandEncoder();const s=this._commandEncoder.beginComputePass();s.setPipeline(this._computePipeline);for(let t=0;t<e.length;t++)s.setBindGroup(t,e[t]);s.dispatchWorkgroups(i),s.end(),this._commandEncoder.copyBufferToBuffer(t,0,r,0,r.size),this._device.queue.submit([this._commandEncoder.finish()])}createBuffer(e,t){if(this._device)return this._device.createBuffer({size:e,usage:t})}writeToBuffer(e,t){this._device&&this._device.queue.writeBuffer(e,0,t)}createBindGroup(e){if(this._device&&this._computePipeline)return this._device.createBindGroup({entries:e.map(((e,t)=>({binding:t,resource:{buffer:e}}))),layout:this._computePipeline.getBindGroupLayout(0)})}async _initWebGPU(){if(!navigator.gpu)throw new Error("WebGPU Not Supported");const e=await navigator.gpu.requestAdapter({powerPreference:"high-performance"});if(!e)throw new Error("Could not get adapter");this._device=await e.requestDevice({requiredLimits:{maxStorageBufferBindingSize:e.limits.maxStorageBufferBindingSize}})}async _initComputePipeline(){if(!this._device)return;const e={layout:"auto",compute:{module:this._device.createShaderModule({code:this._computeShader}),entryPoint:"main"}};this._computePipeline=await this._device.createComputePipelineAsync(e)}}class a{constructor(){this.webGPUComputer=null,this.workerGroups=null}async init(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:100;this.webGPUComputer=await o.init("\n@group(0) @binding(0) var<storage, read> data: array<f32>;\n@group(0) @binding(1) var<storage, read_write> result: array<f32>;\n\n// global_id -> thread index\n// workgroup_size -> number of threads\n// global_invocation_id -> thread id in the group\n\n@compute @workgroup_size(1)\nfn main(@builtin(global_invocation_id) global_id: vec3<u32>) {\n    let index = global_id.x;\n    result[index] = data[global_id.x] + 1;\n}\n");const t=new Float32Array(Array.from({length:e},(()=>Math.random())));this.dataBuffer=this.webGPUComputer.createBuffer(t.byteLength,GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_DST),this.webGPUComputer.writeToBuffer(this.dataBuffer,t),this.workerGroups=t.length,this.resultBuffer=this.webGPUComputer.createBuffer(4*Math.ceil(this.workerGroups),GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_SRC),this.bindGroup=this.webGPUComputer.createBindGroup([this.dataBuffer,this.resultBuffer]),this.readBuffer=this.webGPUComputer.createBuffer(4*Math.ceil(this.workerGroups),GPUBufferUsage.MAP_READ|GPUBufferUsage.COPY_DST)}run(){performance.now();this.webGPUComputer.run([this.bindGroup],this.resultBuffer,this.readBuffer,this.workerGroups)}}class u extends n.A{async setupAssets(e){const{programs:t}=await super.setupAssets(e),r=new Float32Array([0,.5,0,0,.5,.5,.5,0]);this.pointCount=r.length/2;const i=this.context.getDevice();this.vertexBuffer=i.createBuffer({label:"vertex buffer",size:r.byteLength,usage:window.GPUBufferUsage.VERTEX|window.GPUBufferUsage.COPY_DST}),i.queue.writeBuffer(this.vertexBuffer,0,r);const s=navigator.gpu.getPreferredCanvasFormat();this.pipeline=i.createRenderPipeline({label:"Fish pipeline",layout:"auto",vertex:{module:t.v_fish.get(),entryPoint:"v_main",buffers:[{arrayStride:8,attributes:[{format:"float32x2",offset:0,shaderLocation:0}]}]},fragment:{module:t.f_fish.get(),entryPoint:"f_main",targets:[{format:s}]},primitive:{topology:"triangle-strip",cullMode:"back"}}),this.compute=new a,await this.compute.init(100)}update(){super.update(),this.compute.run()}render(){super.render();const e=this.context.getDevice(),t=e.createCommandEncoder({label:"Fish Command Encoder"}),r=t.beginRenderPass({label:"Fish Pass Descriptor",colorAttachments:[{view:this.context.getCurrentTexture().createView(),clearValue:{r:0,g:0,b:0,a:0},loadOp:"clear",storeOp:"store"}]});r.setPipeline(this.pipeline),r.setVertexBuffer(0,this.vertexBuffer),r.draw(this.pointCount),r.end(),e.queue.submit([t.finish()])}resize(e){}destroy(){super.destroy()}}let c=null;const d=async()=>{c=new i.A,await c.setup(u,s);const e=document.querySelector(`#${s.slug}`),t=c.getCanvas();t&&e&&e.appendChild(t)},h=()=>{c?.destroy()}},65304(e,t,r){r.d(t,{A:()=>i});const i=class{constructor(){this.program=null}setup(e,t,r){this.program=e.createShaderModule({label:t,code:r})}get(){return this.program}}}}]);
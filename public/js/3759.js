"use strict";(self.webpackChunkdovotori=self.webpackChunkdovotori||[]).push([[3759,4937],{44937:(t,e,i)=>{i.r(e),i.d(e,{IndexedDb:()=>s});class s{constructor(t){this.db=null,this.dbName=t,this.objectStoreAlreadyExist={}}deleteDb(){return new Promise(((t,e)=>{const i=window.indexedDB.deleteDatabase(this.dbName);i.onerror=t=>{e(t)},i.onsuccess=e=>{t(e.result)}}))}setup(t){return new Promise(((e,i)=>{const s=window.indexedDB.open(this.dbName);s.onerror=t=>{i(t)},s.onupgradeneeded=e=>{this.db=e.target.result,t.forEach((t=>{this.db.createObjectStore(t.name,{keyPath:t.keyPath}).createIndex(t.keyPath,t.keyPath,{unique:t.unique})}))},s.onsuccess=i=>{this.db=i.target.result,t.forEach((t=>{this.db.objectStoreNames.contains(t.name)&&(this.objectStoreAlreadyExist[t.name]=!0)})),e()}}))}upsertData(t,e){return new Promise(((i,s)=>{this.db||s("db is not yet defined.");const n=this.db.transaction([t],"readwrite");n.oncomplete=t=>{i(t)},n.onerror=t=>{s(t)};const r=n.objectStore(t);e.forEach((t=>{const e=r.put(t);e.onsuccess=()=>{},e.onerror=t=>{s(t)}}))}))}getData(t,e){return new Promise(((i,s)=>{const n=this.db.transaction([t]).objectStore(t).get(e);n.onerror=t=>{s(t)},n.onsuccess=()=>{i(n.result)}}))}isStoreExist(t){return this.objectStoreAlreadyExist[t]??!1}}},57381:(t,e,i)=>{i.d(e,{A:()=>r});var s=i(27853),n=i(50730);const r=class extends n.A{constructor(t){super(t),this.matIdentity=new s.A,this.projection=new s.A,this.projection.identity(),this.near=t.near??1,this.far=t.far??100,this.angle=t.angle??50,this.matIdentity.identity(),this.lookAt()}update(){this.lookAt()}perspective(t,e){this.projection.identity().perspective(this.angle,t/e,this.near,this.far)}move(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;this.position.set(this.position.getX(),Math.sin(.02*t)*(2+e),this.position.getZ()),this.lookAt()}setNearFar(t,e){this.near=t,this.far=e}setAngle(t){this.angle=t}getModeProjection(){return this.ortho??this.projection}getProjection(){return this.projection}getIdentity(){return this.matIdentity}getNearFar(){return[this.near,this.far]}getNear(){return this.near}getFar(){return this.far}getAngle(){return this.angle}getReflectViewMatrix(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;const e=2*(this.position.getY()-t);return(new s.A).identity().lookAt(this.position.getX(),this.position.getY()-e,this.position.getZ(),this.target.getX(),this.target.getY(),this.target.getZ(),0,1,0)}}},50730:(t,e,i)=>{i.d(e,{A:()=>r});var s=i(75112),n=i(27853);const r=class{constructor(t){if(this.position=new s.A(t.position.x,t.position.y,t.position.z),this.target=new s.A(0,0,0),this.view=new n.A,t.ortho){const{left:e,right:i,bottom:s,top:r}=t.ortho,{near:d,far:o}=t;this.ortho=new n.A,this.ortho.ortho(e,i,s,r,d,o)}}lookAt(){this.view.identity().lookAt(this.position.getX(),this.position.getY(),this.position.getZ(),this.target.getX(),this.target.getY(),this.target.getZ(),0,1,0)}getView(){return this.view}getPosition(){return this.position.get()}getPositionVec3(){return this.position}getTarget(){return this.target.get()}getModel(){return this.repere.getModel()}getOrtho(){return this.ortho}addToPosition(t,e,i){this.position.addXYZ(t,e,i),this.lookAt()}setPosition(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;const s=null!==t?t:this.position.getX(),n=null!==e?e:this.position.getY(),r=null!==i?i:this.position.getZ();this.position.set(s,n,r),this.lookAt()}setTarget(t,e,i){this.target.set(t,e,i)}setTargetVec3(t){this.target.equal(t)}}},20769:(t,e,i)=>{i.d(e,{A:()=>d});var s=i(79678),n=i(2823),r=i(27853);const d=class{constructor(){this.d=new Float32Array(8),this.identity()}identity(){return this.d[0]=0,this.d[1]=0,this.d[2]=0,this.d[3]=1,this.d[4]=0,this.d[5]=0,this.d[6]=0,this.d[7]=0,this}set(t,e,i,s,n,r,d,o){return this.d[0]=t,this.d[1]=e,this.d[2]=i,this.d[3]=s,this.d[4]=n,this.d[5]=r,this.d[6]=d,this.d[7]=o,this}add(t){return this.d[0]+=t.d[0],this.d[1]+=t.d[1],this.d[2]+=t.d[2],this.d[3]+=t.d[3],this.d[4]+=t.d[4],this.d[5]+=t.d[5],this.d[6]+=t.d[6],this.d[7]+=t.d[7],this}translate(t){const e=this.d[0],i=this.d[1],s=this.d[2],n=this.d[3],r=.5*t[0],d=.5*t[1],o=.5*t[2],h=this.d[4],a=this.d[5],u=this.d[6],l=this.d[7];return this.d[0]=e,this.d[1]=i,this.d[2]=s,this.d[3]=n,this.d[4]=n*r+i*o-s*d+h,this.d[5]=n*d+s*r-e*o+a,this.d[6]=n*o+e*d-i*r+u,this.d[7]=-e*r-i*d-s*o+l,this}multiply(t){const e=this.d[0],i=this.d[1],s=this.d[2],n=this.d[3],r=t.d[4],d=t.d[5],o=t.d[6],h=t.d[7],a=this.d[4],u=this.d[5],l=this.d[6],g=this.d[7],c=t.d[0],f=t.d[1],p=t.d[2],m=t.d[3];return this.d[0]=e*m+n*c+i*p-s*f,this.d[1]=i*m+n*f+s*c-e*p,this.d[2]=s*m+n*p+e*f-i*c,this.d[3]=n*m-e*c-i*f-s*p,this.d[4]=e*h+n*r+i*o-s*d+a*m+g*c+u*p-l*f,this.d[5]=i*h+n*d+s*r-e*o+u*m+g*f+l*c-a*p,this.d[6]=s*h+n*o+e*d-i*r+l*m+g*p+a*f-u*c,this.d[7]=n*h-e*r-i*d-s*o+g*m-a*c-u*f-l*p,this}scale(t){return this.d[0]*=t,this.d[1]*=t,this.d[2]*=t,this.d[3]*=t,this.d[4]*=t,this.d[5]*=t,this.d[6]*=t,this.d[7]*=t,this}rotateX(t){let e=-this.d[0],i=-this.d[1],s=-this.d[2],r=this.d[3];const d=this.d[4],o=this.d[5],h=this.d[6],a=this.d[7],u=d*r+a*e+o*s-h*i,l=o*r+a*i+h*e-d*s,g=h*r+a*s+d*i-o*e,c=a*r-d*e-o*i-h*s,f=new n.A(this.d[0],this.d[1],this.d[2],this.d[3]);return f.rotateX(t),this.d[0]=f.getX(),this.d[1]=f.getY(),this.d[2]=f.getZ(),this.d[3]=f.getW(),e=f.getX(),i=f.getY(),s=f.getZ(),r=f.getW(),this.d[4]=u*r+c*e+l*s-g*i,this.d[5]=l*r+c*i+g*e-u*s,this.d[6]=g*r+c*s+u*i-l*e,this.d[7]=c*r-u*e-l*i-g*s,this}rotateY(t){let e=-this.d[0],i=-this.d[1],s=-this.d[2],r=this.d[3];const d=this.d[4],o=this.d[5],h=this.d[6],a=this.d[7],u=d*r+a*e+o*s-h*i,l=o*r+a*i+h*e-d*s,g=h*r+a*s+d*i-o*e,c=a*r-d*e-o*i-h*s,f=new n.A(this.d[0],this.d[1],this.d[2],this.d[3]);return f.rotateY(t),this.d[0]=f.getX(),this.d[1]=f.getY(),this.d[2]=f.getZ(),this.d[3]=f.getW(),e=f.getX(),i=f.getY(),s=f.getZ(),r=f.getW(),this.d[4]=u*r+c*e+l*s-g*i,this.d[5]=l*r+c*i+g*e-u*s,this.d[6]=g*r+c*s+u*i-l*e,this.d[7]=c*r-u*e-l*i-g*s,this}rotateZ(t){let e=-this.d[0],i=-this.d[1],s=-this.d[2],r=this.d[3];const d=this.d[4],o=this.d[5],h=this.d[6],a=this.d[7],u=d*r+a*e+o*s-h*i,l=o*r+a*i+h*e-d*s,g=h*r+a*s+d*i-o*e,c=a*r-d*e-o*i-h*s,f=new n.A(this.d[0],this.d[1],this.d[2],this.d[3]);return f.rotateZ(t),this.d[0]=f.getX(),this.d[1]=f.getY(),this.d[2]=f.getZ(),this.d[3]=f.getW(),e=f.getX(),i=f.getY(),s=f.getZ(),r=f.getW(),this.d[4]=u*r+c*e+l*s-g*i,this.d[5]=l*r+c*i+g*e-u*s,this.d[6]=g*r+c*s+u*i-l*e,this.d[7]=c*r-u*e-l*i-g*s,this}rotateAroundAxis(t,e){if(Math.abs(e)<s.p)return this;const i=Math.hypot(t[0],t[1],t[2]),n=.5*e,r=Math.sin(n),d=r*t[0]/i,o=r*t[1]/i,h=r*t[2]/i,a=Math.cos(n),u=this.d[0],l=this.d[1],g=this.d[2],c=this.d[3];this.d[0]=u*a+c*d+l*h-g*o,this.d[1]=l*a+c*o+g*d-u*h,this.d[2]=g*a+c*h+u*o-l*d,this.d[3]=c*a-u*d-l*o-g*h;const f=this.d[4],p=this.d[5],m=this.d[6],b=this.d[7];return this.d[4]=f*a+b*d+p*h-m*o,this.d[5]=p*a+b*o+m*d-f*h,this.d[6]=m*a+b*h+f*o-p*d,this.d[7]=b*a-f*d-p*o-m*h,this}getTranslation(){const t=this.d[4],e=this.d[5],i=this.d[6],s=this.d[7],n=-this.d[0],r=-this.d[1],d=-this.d[2],o=this.d[3],h=[3];return h[0]=2*(t*o+s*n+e*d-i*r),h[1]=2*(e*o+s*r+i*n-t*d),h[2]=2*(i*o+s*d+t*r-e*n),h}toMatrix4(){const t=[16];t[0]=1-2*this.d[1]*this.d[1]-2*this.d[2]*this.d[2],t[1]=2*this.d[0]*this.d[1]+2*this.d[3]*this.d[2],t[2]=2*this.d[0]*this.d[2]-2*this.d[3]*this.d[1],t[3]=0,t[4]=2*this.d[0]*this.d[1]-2*this.d[3]*this.d[2],t[5]=1-2*this.d[0]*this.d[0]-2*this.d[2]*this.d[2],t[6]=2*this.d[1]*this.d[2]+2*this.d[3]*this.d[0],t[7]=0,t[8]=2*this.d[0]*this.d[2]+2*this.d[3]*this.d[1],t[9]=2*this.d[1]*this.d[2]-2*this.d[3]*this.d[0],t[10]=1-2*this.d[0]*this.d[0]-2*this.d[1]*this.d[1],t[11]=0,t[12]=2*(-this.d[7]*this.d[0]+this.d[4]*this.d[3]-this.d[5]*this.d[2]+this.d[6]*this.d[1]),t[13]=2*(-this.d[7]*this.d[1]+this.d[4]*this.d[2]+this.d[5]*this.d[3]-this.d[6]*this.d[0]),t[14]=2*(-this.d[7]*this.d[2]-this.d[4]*this.d[1]+this.d[5]*this.d[0]+this.d[6]*this.d[3]),t[15]=1;return(new r.A).setFromArray(t)}get(){return this.d}}},55325:(t,e,i)=>{i.d(e,{A:()=>s});const s=class{constructor(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;this.d=[0,0,0,0],this.set(t,e,i,s)}normalise(){const t=this.length();return 0!==t&&(this.d[0]/=t,this.d[1]/=t,this.d[2]/=t,this.d[3]/=t),this}get(){return this.d}getX(){return this.d[0]}getY(){return this.d[1]}getZ(){return this.d[2]}getW(){return this.d[3]}length(){return Math.sqrt(this.d[0]*this.d[0]+this.d[1]*this.d[1]+this.d[2]*this.d[2]+this.d[3]*this.d[3])}set(t,e,i,s){return null!=t&&(this.d[0]=t),null!=e?this.d[1]=e:null!=t&&(this.d[1]=t),null!=i?this.d[2]=i:null!=t&&(this.d[2]=t),null!=s?this.d[3]=s:null!=t&&(this.d[3]=t),this}equal(t){return this.d=[t.d[0],t.d[1],t.d[2],t.d[3]],this}add(t){return this.d[0]+=t.d[0],this.d[1]+=t.d[1],this.d[2]+=t.d[2],this.d[3]+=t.d[3],this}addNumber(t){return this.d[0]+=t,this.d[1]+=t,this.d[2]+=t,this.d[3]+=t,this}minus(t){return this.d[0]-=t.d[0],this.d[1]-=t.d[1],this.d[2]-=t.d[2],this.d[3]-=t.d[3],this}minusNumber(t){return this.d[0]-=t,this.d[1]-=t,this.d[2]-=t,this.d[3]-=t,this}multiplyNumber(t){return this.d[0]*=t,this.d[1]*=t,this.d[2]*=t,this.d[3]*=t,this}multiplyMatrix(t){const e=this.d[0],i=this.d[1],s=this.d[2],n=this.d[3];return this.d[0]=t.d[0]*e+t.d[4]*i+t.d[8]*s+t.d[12]*n,this.d[1]=t.d[1]*e+t.d[5]*i+t.d[9]*s+t.d[13]*n,this.d[2]=t.d[2]*e+t.d[6]*i+t.d[10]*s+t.d[14]*n,this.d[3]=t.d[3]*e+t.d[7]*i+t.d[11]*s+t.d[15]*n,this}multiply(t){return this.d[0]*=t.d[0],this.d[1]*=t.d[1],this.d[2]*=t.d[2],this.d[3]*=t.d[3],this}divideNumber(t){return this.d[0]/=t,this.d[1]/=t,this.d[2]/=t,this.d[3]/=t,this}divide(t){return this.d[0]/=t.d[0],this.d[1]/=t.d[1],this.d[2]/=t.d[2],this.d[3]/=t.d[3],this}distance(t){return Math.sqrt((t.d[0]-this.d[0])*(t.d[0]-this.d[0])+(t.d[1]-this.d[1])*(t.d[1]-this.d[1])+(t.d[2]-this.d[2])*(t.d[2]-this.d[2])+(t.d[3]-this.d[3])*(t.d[3]-this.d[3]))}}},68153:(t,e,i)=>{i.d(e,{A:()=>s});const s={position:[1,1,1,-1,1,1,-1,-1,1,1,-1,1,1,1,1,1,-1,1,1,-1,-1,1,1,-1,1,1,1,1,1,-1,-1,1,-1,-1,1,1,-1,1,1,-1,1,-1,-1,-1,-1,-1,-1,1,-1,-1,-1,1,-1,-1,1,-1,1,-1,-1,1,1,-1,-1,-1,-1,-1,-1,1,-1,1,1,-1],indices:[0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19,20,21,22,20,22,23],texture:[1,1,0,1,0,0,1,0,0,0,1,0,1,1,0,1,0,0,0,1,1,1,1,0,0,0,0,1,1,1,1,0,0,0,1,0,1,1,0,1,0,0,1,0,1,1,0,1]}},3759:(t,e,i)=>{i.r(e),i.d(e,{default:()=>x,destroy:()=>P});var s=i(83886);const n={slug:"webgpu",shaders:["/wgsl/vertex/v_gltf.js","/wgsl/fragment/f_gltf.js","/wgsl/vertex/v_picking.js","/wgsl/fragment/f_picking.js","/wgsl/vertex/v_debug_tex.js","/wgsl/vertex/v_shadow_depth.js","/wgsl/fragment/f_debug_tex.js","/wgsl/vertex/v_model_camera.js","/wgsl/fragment/f_simple.js"],assets:["/gltf/paysage9-testTex.gltf"],canvas:{width:1024,height:1024},camera:{position:{x:0,y:4,z:30},target:{x:0,y:0,z:0},near:1,far:60,angle:60},lampes:[{type:0,position:{x:-20,y:20,z:-2},target:{x:0,y:0,z:0},ambiant:[1,1,.2],diffuse:[1,1,1],specular:[1,1,1],strength:2,brillance:1,near:1,far:40,ortho:{left:-15,right:15,bottom:-15,top:15}},{type:0,position:{x:-10,y:20,z:10},ambiant:[1,.2,.3],strength:1}],controls:{fullscreen:{buttonId:"fullscreen-toggle-btn"}},useWebGpu:!0,mouse:{events:["click"]}};var r=i(54705),d=i(57381),o=i(50730),h=i(20769),a=i(27853),u=i(75112),l=i(55325);var g=i(92093),c=i(68153),f=i(28649),p=i(66121);class m{constructor(t){(0,r.A)(this,"setup",(async t=>{const e=new Float32Array(c.A.position),i=this.context.getDevice();this.buffers.vertex=i.createBuffer({label:"debug vertex buffer",size:4*Math.ceil(e.byteLength/4),mappedAtCreation:!0,usage:window.GPUBufferUsage.VERTEX|window.GPUBufferUsage.COPY_DST});new Float32Array(this.buffers.vertex.getMappedRange()).set(e),this.buffers.vertex.unmap();const s=new Uint16Array(c.A.indices);this.buffers.index=i.createBuffer({label:"debug index buffer",size:4*Math.ceil(s.byteLength/4),mappedAtCreation:!0,usage:window.GPUBufferUsage.INDEX|window.GPUBufferUsage.COPY_DST});new Uint16Array(this.buffers.index.getMappedRange()).set(s),this.buffers.index.unmap(),this.pipeline=await i.createRenderPipelineAsync({label:"Debug pipeline",layout:"auto",vertex:{module:t.vertex,entryPoint:"v_main",buffers:[{arrayStride:3*Float32Array.BYTES_PER_ELEMENT,attributes:[{format:"float32x3",offset:0,shaderLocation:0}]}]},fragment:{module:t.fragment,entryPoint:"f_main",targets:[{format:"bgra8unorm",blend:f.a}]},primitive:{topology:"triangle-list",cullMode:"back"},depthStencil:{depthWriteEnabled:!0,depthCompare:"less",format:"depth32float"},multisample:{count:this.sampleCount}}),this.setTransform(4,4,4)})),(0,r.A)(this,"render",((t,e)=>{t.setPipeline(this.pipeline),t.setBindGroup(p.Tq.CAMERA,e),t.setBindGroup(p.Tq.TRANSFORM,this.transformUniformBindGroup),t.setVertexBuffer(0,this.buffers.vertex),t.setIndexBuffer(this.buffers.index,"uint16"),t.drawIndexed(c.A.indices.length)})),(0,r.A)(this,"getBindGroupLayout",(t=>this.pipeline.getBindGroupLayout(t))),this.context=t,this.pipeline=void 0,this.buffers={vertex:void 0,index:void 0},this.transformUniformBindGroup=void 0,this.renderPassDescriptor=void 0,this.sampleCount=4}setTransform(t,e,i){const s=this.context.getDevice(),n=s.createBuffer({size:16*Float32Array.BYTES_PER_ELEMENT,usage:window.GPUBufferUsage.UNIFORM|window.GPUBufferUsage.COPY_DST,mappedAtCreation:!0}),r=new Float32Array(n.getMappedRange()),d=new a.A;d.identity().scale(.1).translate(t,e,i),r.set(d.get()),n.unmap(),this.transformUniformBindGroup=s.createBindGroup({label:"debug bind group transform",layout:this.pipeline.getBindGroupLayout(p.Tq.TRANSFORM),entries:[{binding:0,resource:{buffer:n}}]})}}var b=i(44937);class w{constructor(){this.dbName="gltf",this.db=new b.IndexedDb(this.dbName)}async setup(){await this.db.setup([{name:"faces",keyPath:"meshIdIndex",unique:!0},{name:"matrices",keyPath:"meshId",unique:!0}])}async addFacesData(t){await this.db.upsertData("faces",t)}async addNodeMatricesData(t){await this.db.upsertData("matrices",t)}async getMeshFaceData(t){return this.db.getData("faces",t)}async getMeshMatrixData(t){return this.db.getData("matrices",t)}isStoreFacesExist(){return this.db.isStoreExist("faces")}isStoreNodeMatricesExist(){return this.db.isStoreExist("matrices")}}const y=!0;const v=class{constructor(t,e){(0,r.A)(this,"onMouseClick",(async t=>{this.updateCameraUniforms(this.pickingUniformCamera.buffer),await this.picking.pick(t.pos,this.pickingUniformCamera.bindGroup,this.gltfPipeline.getDrawNodes(),this.gltfPipeline.getAnimations());const e=await this.picking.pick(t.pos,this.pickingUniformCamera.bindGroup,this.gltfPipeline.getDrawNodes(),this.gltfPipeline.getAnimations()),{node:i,positions:s,matrix:n}=await this.gltfPipeline.getByPickColor(e),r={x:t.pos.x/t.size.width*2-1,y:t.pos.y/t.size.height*2-1},d=this.camera.getProjection(),o=this.camera.getView(),h=(new a.A).setFromArray(d.get()).inverse(),g=(new a.A).setFromArray(o.get()).inverse(),c=new l.A(r.x,r.y,-1,1).multiplyMatrix(h);c.set(c.getX(),c.getY(),-1,0);const f=c.multiplyMatrix(g).normalise();if(s&&n){s[0];const t=new u.A(s[1][0],s[1][1],s[1][2]),e=new u.A(s[2][0],s[2][1],s[2][2]),i=new u.A(s[0][0],s[0][1],s[0][2]).computeNormal(t,e),n=function(t,e,i,s){const n=s.dot(e);if(0===n)return null;const r=i.clone().minus(t).dot(s)/n;return r<0?null:e.clone().multiplyNumber(r).add(t)}(this.camera.getPositionVec3(),new u.A(f.getX(),f.getY(),f.getZ()),t,i);this.debugCube.setTransform(n.getX(),n.getY(),n.getZ())}})),this.context=t,this.config=e,this.time=0;const{width:i,height:s}=this.config.canvas;this.camera=new d.A(e.camera),this.camera.perspective(i,s),this.canvasSize={width:i,height:s},this.model=new a.A,this.model.identity(),this.gltfPipeline=new g.GltfPipeline(t,e),this.picking=new g.Picking(t),this.shadow=new g.Shadow(t),this.debug=new g.DebugTexture(t),this.lampe=new o.A(e.lampes[0]),this.lampe.lookAt(),this.debugCube=new m(t)}setup(){}setupCamera(t,e){const i=this.context.getDevice(),s=i.createBuffer({size:52*Float32Array.BYTES_PER_ELEMENT,usage:window.GPUBufferUsage.UNIFORM|window.GPUBufferUsage.COPY_DST}),n=[{binding:0,resource:{buffer:s}}];let r;e&&(r=i.createBuffer({label:"LightProjBuffer",size:16*Float32Array.BYTES_PER_ELEMENT,usage:window.GPUBufferUsage.UNIFORM|window.GPUBufferUsage.COPY_DST}),n.push({binding:1,resource:{buffer:r}}));return{buffer:s,bindGroup:i.createBindGroup({label:"CameraUniforms",layout:t,entries:n}),bufferLightProj:r}}setupLights(t){const e=this.context.getDevice(),i=8*Float32Array.BYTES_PER_ELEMENT*this.config.lampes.length,s=e.createBuffer({label:"Light Storage Buffer",size:i,usage:window.GPUBufferUsage.STORAGE|window.GPUBufferUsage.COPY_DST}),n=[];this.config.lampes.forEach((t=>{const e=[t.position.x,t.position.y,t.position.z,0,...t.ambiant,t.strength];n.push(...e)}));const r=new Float32Array(n);e.queue.writeBuffer(s,0,r.buffer,r.byteOffset,r.byteLength);return{buffer:s,bindGroup:e.createBindGroup({label:"LightsUniforms",layout:t,entries:[{binding:0,resource:{buffer:s}}]})}}async setupAssets(t){const e=this.context.getDevice(),i=Object.keys(t.shaders).reduce(((i,s)=>{const n=new g.Program;return n.setup(e,s,t.shaders[s]),i[s]=n,i}),{}),s=Object.keys(t.gltfs)[0],n=t.gltfs[s],r={vertex:i.v_gltf.get(),fragment:i.f_gltf.get()};await this.shadow.setup({vertex:i.v_shadow_depth.get()},[this.gltfPipeline.getFirstBufferLayout()]),await this.gltfPipeline.setupDb(new w("gltf")),await this.gltfPipeline.setup(n,r,this.canvasSize,this.shadow.getShadowMapBindGroupEntries(e,this.lampe.getPosition()),y),this.uniformCamera=this.setupCamera(this.gltfPipeline.getBindGroupLayout(g.GltfBindGroups.CAMERA),!0),this.uniformLights=this.setupLights(this.gltfPipeline.getBindGroupLayout(g.GltfBindGroups.LIGHT)),await this.picking.setup({vertex:i.v_picking.get(),fragment:i.f_picking.get()},this.canvasSize,[this.gltfPipeline.getFirstBufferLayout()]),this.pickingUniformCamera=this.setupCamera(this.picking.getBindGroupLayout(g.GltfBindGroups.CAMERA)),this.picking.setTransformBindGroups(this.gltfPipeline.buildTransformBindGroups(this.picking.getBindGroupLayout(g.GltfBindGroups.TRANSFORM))),this.shadowUniformCamera=this.setupCamera(this.shadow.getBindGroupLayout(g.GltfBindGroups.CAMERA)),this.shadow.setTransformBindGroups(this.gltfPipeline.buildTransformBindGroups(this.shadow.getBindGroupLayout(g.GltfBindGroups.TRANSFORM))),await this.debugCube.setup({vertex:i.v_model_camera.get(),fragment:i.f_simple.get()}),this.debugUniformCamera=this.setupCamera(this.debugCube.getBindGroupLayout(g.GltfBindGroups.CAMERA)),this.debugCube.setTransform(-.4425056576728821,1.8546216487884521,-.8446273803710938),this.debug.setup({vertex:i.v_debug_tex.get(),fragment:i.f_debug_tex.get()},this.shadow.getSize()),this.debug.setTexture(this.shadow.getDepthTexture())}update(t){this.model.identity();const e=new h.A;e.rotateY(1e-4*t),this.model.multiply(e.toMatrix4()),this.gltfPipeline.updateAnimations(t)}updateCameraUniforms(t,e){const i=this.context.getDevice(),s=this.camera.getModeProjection().get(),n=this.camera.getView().get(),r=new Float32Array(51);if(r.set(s,0),r.set(n,16),r.set(this.model.get(),32),r.set(this.camera.getPosition(),48),i.queue.writeBuffer(t,0,r.buffer,r.byteOffset,r.byteLength),e){const t=(new a.A).setFromArray(this.lampe.getView().get()),s=new Float32Array(16);s.set(t.multiply(this.lampe.getOrtho()).get(),0),i.queue.writeBuffer(e,0,s.buffer,s.byteOffset,s.byteLength)}}updateCameraUniformsWithLight(t){const e=this.context.getDevice(),i=this.lampe.getOrtho().get(),s=this.lampe.getView().get(),n=new Float32Array(i.concat(s,this.model.get(),this.lampe.getPosition()));e.queue.writeBuffer(t,0,n.buffer,n.byteOffset,n.byteLength)}render(){const t=this.context.getDevice();this.gltfPipeline.update(),this.renderShadowDepthPass(),this.updateCameraUniforms(this.uniformCamera.buffer,this.uniformCamera.bufferLightProj);const e=t.createCommandEncoder({label:"GltfCommandEncoder"}),i=e.beginRenderPass(this.gltfPipeline.getRenderPassDescriptor());i.setPipeline(this.gltfPipeline.get()),i.setBindGroup(g.GltfBindGroups.CAMERA,this.uniformCamera.bindGroup),i.setBindGroup(g.GltfBindGroups.LIGHT,this.uniformLights.bindGroup),this.gltfPipeline.drawModel(t,i,y),this.updateCameraUniforms(this.debugUniformCamera.buffer),this.debugCube.render(i,this.debugUniformCamera.bindGroup),i.end(),t.queue.submit([e.finish()])}renderShadowDepthPass(){this.updateCameraUniformsWithLight(this.shadowUniformCamera.buffer),this.shadow.render(this.shadowUniformCamera.bindGroup,this.gltfPipeline.getDrawNodes(),this.gltfPipeline.getAnimations())}resize(t){this.canvasSize=t,this.gltfPipeline.resize(t),this.picking.resize(t)}};i(19513),i(807);let A=null;const x=async()=>{A=new s.A,await A.setup(v,n)},P=()=>{A&&A.destroy&&A.destroy()}},77314:(t,e,i)=>{i.d(e,{A:()=>o});var s=i(31601),n=i.n(s),r=i(76314),d=i.n(r)()(n());d.push([t.id,"#controls {\n  position: absolute;\n  top: 0;\n  right: 0;\n  display: flex;\n  align-items: stretch;\n  z-index: 10;\n  background-color: rgba(34, 34, 34, .8);\n  margin: .5em;\n  padding: .5em;\n}\n\n#controls div {\n  display: flex;\n  align-items: stretch;\n}\n\n#controls div input[type=range] {\n  width: 100%;\n}\n\n#controls div input[type=checkbox] {\n  margin-right: 0.5em;\n}\n\n#controls label {\n  display: flex;\n  align-items: center;\n}\n\n#controls label,\n#controls a {\n  font-size: .8em;\n}\n\n@media (max-width: 570px) {\n  #controls.responsive {\n    position: relative;\n    width: 100%;\n    margin: 0;\n  }\n}",""]);const o=d},55420:(t,e,i)=>{i.d(e,{A:()=>o});var s=i(31601),n=i.n(s),r=i(76314),d=i.n(r)()(n());d.push([t.id,"#fullscreen-toggle-btn {\n  border-radius: 0;\n  margin: 0;\n  padding: 4px;\n  border: solid 2px var(--project-color);\n}\n\n#fullscreen-toggle-btn:hover svg,\n#fullscreen-toggle-btn:active svg {\n  transform: scale(0.8);\n  opacity: 1;\n}\n\n#fullscreen-toggle-btn svg {\n  display: block;\n  width: 2em;\n  fill: #fff;\n  opacity: 0.8;\n  transform: scale(0.6);\n  transition: opacity 300ms ease-out, transform 300ms ease-out;\n}\n\n[data-fullscreen] {\n  display: flex;\n  justify-content: center;\n  align-items: center;\n}\n",""]);const o=d},76314:t=>{t.exports=function(t){var e=[];return e.toString=function(){return this.map((function(e){var i="",s=void 0!==e[5];return e[4]&&(i+="@supports (".concat(e[4],") {")),e[2]&&(i+="@media ".concat(e[2]," {")),s&&(i+="@layer".concat(e[5].length>0?" ".concat(e[5]):""," {")),i+=t(e),s&&(i+="}"),e[2]&&(i+="}"),e[4]&&(i+="}"),i})).join("")},e.i=function(t,i,s,n,r){"string"==typeof t&&(t=[[null,t,void 0]]);var d={};if(s)for(var o=0;o<this.length;o++){var h=this[o][0];null!=h&&(d[h]=!0)}for(var a=0;a<t.length;a++){var u=[].concat(t[a]);s&&d[u[0]]||(void 0!==r&&(void 0===u[5]||(u[1]="@layer".concat(u[5].length>0?" ".concat(u[5]):""," {").concat(u[1],"}")),u[5]=r),i&&(u[2]?(u[1]="@media ".concat(u[2]," {").concat(u[1],"}"),u[2]=i):u[2]=i),n&&(u[4]?(u[1]="@supports (".concat(u[4],") {").concat(u[1],"}"),u[4]=n):u[4]="".concat(n)),e.push(u))}},e}},31601:t=>{t.exports=function(t){return t[1]}},19513:(t,e,i)=>{var s=i(85072),n=i.n(s),r=i(97825),d=i.n(r),o=i(77659),h=i.n(o),a=i(55056),u=i.n(a),l=i(10540),g=i.n(l),c=i(41113),f=i.n(c),p=i(77314),m={};m.styleTagTransform=f(),m.setAttributes=u(),m.insert=h().bind(null,"head"),m.domAPI=d(),m.insertStyleElement=g();n()(p.A,m),p.A&&p.A.locals&&p.A.locals},807:(t,e,i)=>{var s=i(85072),n=i.n(s),r=i(97825),d=i.n(r),o=i(77659),h=i.n(o),a=i(55056),u=i.n(a),l=i(10540),g=i.n(l),c=i(41113),f=i.n(c),p=i(55420),m={};m.styleTagTransform=f(),m.setAttributes=u(),m.insert=h().bind(null,"head"),m.domAPI=d(),m.insertStyleElement=g();n()(p.A,m),p.A&&p.A.locals&&p.A.locals},85072:t=>{var e=[];function i(t){for(var i=-1,s=0;s<e.length;s++)if(e[s].identifier===t){i=s;break}return i}function s(t,s){for(var r={},d=[],o=0;o<t.length;o++){var h=t[o],a=s.base?h[0]+s.base:h[0],u=r[a]||0,l="".concat(a," ").concat(u);r[a]=u+1;var g=i(l),c={css:h[1],media:h[2],sourceMap:h[3],supports:h[4],layer:h[5]};if(-1!==g)e[g].references++,e[g].updater(c);else{var f=n(c,s);s.byIndex=o,e.splice(o,0,{identifier:l,updater:f,references:1})}d.push(l)}return d}function n(t,e){var i=e.domAPI(e);i.update(t);return function(e){if(e){if(e.css===t.css&&e.media===t.media&&e.sourceMap===t.sourceMap&&e.supports===t.supports&&e.layer===t.layer)return;i.update(t=e)}else i.remove()}}t.exports=function(t,n){var r=s(t=t||[],n=n||{});return function(t){t=t||[];for(var d=0;d<r.length;d++){var o=i(r[d]);e[o].references--}for(var h=s(t,n),a=0;a<r.length;a++){var u=i(r[a]);0===e[u].references&&(e[u].updater(),e.splice(u,1))}r=h}}},77659:t=>{var e={};t.exports=function(t,i){var s=function(t){if(void 0===e[t]){var i=document.querySelector(t);if(window.HTMLIFrameElement&&i instanceof window.HTMLIFrameElement)try{i=i.contentDocument.head}catch(t){i=null}e[t]=i}return e[t]}(t);if(!s)throw new Error("Couldn't find a style target. This probably means that the value for the 'insert' parameter is invalid.");s.appendChild(i)}},10540:t=>{t.exports=function(t){var e=document.createElement("style");return t.setAttributes(e,t.attributes),t.insert(e,t.options),e}},55056:(t,e,i)=>{t.exports=function(t){var e=i.nc;e&&t.setAttribute("nonce",e)}},97825:t=>{t.exports=function(t){if("undefined"==typeof document)return{update:function(){},remove:function(){}};var e=t.insertStyleElement(t);return{update:function(i){!function(t,e,i){var s="";i.supports&&(s+="@supports (".concat(i.supports,") {")),i.media&&(s+="@media ".concat(i.media," {"));var n=void 0!==i.layer;n&&(s+="@layer".concat(i.layer.length>0?" ".concat(i.layer):""," {")),s+=i.css,n&&(s+="}"),i.media&&(s+="}"),i.supports&&(s+="}");var r=i.sourceMap;r&&"undefined"!=typeof btoa&&(s+="\n/*# sourceMappingURL=data:application/json;base64,".concat(btoa(unescape(encodeURIComponent(JSON.stringify(r))))," */")),e.styleTagTransform(s,t,e.options)}(e,t,i)},remove:function(){!function(t){if(null===t.parentNode)return!1;t.parentNode.removeChild(t)}(e)}}}},41113:t=>{t.exports=function(t,e){if(e.styleSheet)e.styleSheet.cssText=t;else{for(;e.firstChild;)e.removeChild(e.firstChild);e.appendChild(document.createTextNode(t))}}}}]);
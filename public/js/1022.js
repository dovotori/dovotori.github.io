"use strict";(self.webpackChunkdovotori=self.webpackChunkdovotori||[]).push([[1022],{3195(e,t,r){r.d(t,{A:()=>i});const i={position:[1,1,1,-1,1,1,-1,-1,1,1,-1,1,1,1,1,1,-1,1,1,-1,-1,1,1,-1,1,1,1,1,1,-1,-1,1,-1,-1,1,1,-1,1,1,-1,1,-1,-1,-1,-1,-1,-1,1,-1,-1,-1,1,-1,-1,1,-1,1,-1,-1,1,1,-1,-1,-1,-1,-1,-1,1,-1,1,1,-1],indices:[0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19,20,21,22,20,22,23],texture:[1,1,0,1,0,0,1,0,0,0,1,0,1,1,0,1,0,0,0,1,1,1,1,0,0,0,0,1,1,1,1,0,0,0,1,0,1,1,0,1,0,0,1,0,1,1,0,1]}},15142(e,t,r){r.d(t,{X:()=>s});var i=r(67269);class s{constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:4;this.context=e,this.pipeline=void 0,this.sampleCount=t}setup(e,t,r,i){const s=this.context.getDevice();this.pipeline=s.createRenderPipeline({label:"skybox no attributes",layout:"auto",vertex:{module:e,entryPoint:"v_main"},fragment:{module:e,entryPoint:"f_main",targets:r},depthStencil:{depthWriteEnabled:!0,depthCompare:"less-equal",format:i},multisample:{count:this.sampleCount}});const a=16*Float32Array.BYTES_PER_ELEMENT;this.uniformBuffer=s.createBuffer({label:"skybox uniforms",size:a,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}),this.uniformValues=new Float32Array(a/4),this.viewDirectionProjectionInverseValue=this.uniformValues.subarray(0,16),this.bindGroup=s.createBindGroup({label:"bind group for skybox triangle",layout:this.pipeline.getBindGroupLayout(0),entries:[{binding:0,resource:{buffer:this.uniformBuffer}},{binding:1,resource:t.getSampler(s)},{binding:2,resource:t.getView()}]})}updateCamera(e){const t=this.context.getDevice(),r=e.getViewProjection(),s=new i.A;s.setRaw(r.get()).inverse(),this.viewDirectionProjectionInverseValue.set(s.get()),t.queue.writeBuffer(this.uniformBuffer,0,this.uniformValues)}getPipeline(){return this.pipeline}getBindGroup(){return this.bindGroup}}},41022(e,t,r){r.r(t),r.d(t,{Buffer:()=>i,BufferGltf:()=>o,BufferMaterial:()=>u,BufferTransform:()=>p,Context:()=>g.A,CubeTexture:()=>m.b,DebugPipeline:()=>P,DebugTexture:()=>B,Device:()=>E,GltfBindGroups:()=>x,GltfPipeline:()=>_,Picking:()=>D,Pipeline:()=>V,PipelineTextures:()=>C.A,PostProcess:()=>I.w,Program:()=>O.A,Shadow:()=>z,Skybox:()=>k.X,buildBindGroupLayouts:()=>w,buildPickingBindGroupLayouts:()=>y,buildShadowBindGroupLayouts:()=>A,getNodePickingColor:()=>N,pixelToPickingColor:()=>L});const i=class{constructor(){this.get=()=>this.buffers,this.getLayout=()=>this.layout,this.getIndexCount=()=>this.indexCount}setup(e,t){const{indices:r,position:i}=t;this.indexCount=r.count,this.buffers.vertex=e.createBuffer({label:"vertex buffer",size:i.values.byteLength,usage:window.GPUBufferUsage.VERTEX|window.GPUBufferUsage.COPY_DST}),this.buffers.index=e.createBuffer({label:"index buffer",size:r.values.byteLength,usage:window.GPUBufferUsage.INDEX|window.GPUBufferUsage.COPY_DST}),e.queue.writeBuffer(this.buffers.vertex,0,i.values),e.queue.writeBuffer(this.buffers.index,0,r.values),this.layout={arrayStride:12,attributes:[{format:"float32x3",offset:0,shaderLocation:0}]}}};var s=r(54705),a=r(61451);const n=e=>Math.ceil(e/Float32Array.BYTES_PER_ELEMENT)*Float32Array.BYTES_PER_ELEMENT;const o=class{constructor(){(0,s.A)(this,"setupFaceColorPick",((e,t)=>{this.faceColor=e.createBuffer({label:"face color buffer",size:Float32Array.BYTES_PER_ELEMENT*t.length,mappedAtCreation:!0,usage:window.GPUBufferUsage.VERTEX|window.GPUBufferUsage.COPY_DST});new Float32Array(this.faceColor.getMappedRange()).set(t),this.faceColor.unmap()})),(0,s.A)(this,"getFaceBuffer",(()=>this.faceBuffer)),(0,s.A)(this,"getFaceBufferCount",(()=>this.faceDrawCount)),(0,s.A)(this,"getVertexBuffer",(()=>this.vertex)),(0,s.A)(this,"getIndexBuffer",(()=>this.indexes)),(0,s.A)(this,"getFaceColorBuffer",(()=>this.faceColor)),(0,s.A)(this,"getLayout",(()=>this.layout)),(0,s.A)(this,"getIndexCount",(()=>this.indexCount)),this.vertex=null,this.indexes=null,this.layout=null,this.faceColor=null}setup(e,t,r){const{arrayStride:i,attributes:s,bufferVertex:o,bufferIndex:u,indexCount:l}=t;if(this.indexCount=l,"Pull"===r){Float32Array.BYTES_PER_ELEMENT;const e=(0,a.chunkArray)(o,i/Float32Array.BYTES_PER_ELEMENT),t=[],r=[],s=[],n=[],u=[];for(const i of e)t.push(i.slice(0,3)),r.push(i.slice(3,6)),s.push(i.slice(6,8)),n.push(i.slice(8,12)),u.push(i.slice(12,16))}this.vertex=e.createBuffer({label:"vertex buffer",size:n(o.byteLength),mappedAtCreation:!0,usage:window.GPUBufferUsage.VERTEX|window.GPUBufferUsage.COPY_DST});new Float32Array(this.vertex.getMappedRange()).set(new Float32Array(o,0,this.vertex.byteLength)),this.vertex.unmap(),this.indexes=e.createBuffer({label:"index buffer",size:n(u.byteLength),mappedAtCreation:!0,usage:window.GPUBufferUsage.INDEX|window.GPUBufferUsage.COPY_DST});new Uint16Array(this.indexes.getMappedRange()).set(new Uint16Array(u,0,this.indexes.byteLength)),this.indexes.unmap(),this.layout={arrayStride:i,attributes:s}}setupForFaces(e,t,r){const{arrayStride:i,bufferVertex:s,bufferIndex:a,indexCount:o}=t,u=i/Float32Array.BYTES_PER_ELEMENT,l=new Map;let h=0;for(let e=0;e<s.length;e+=u,h++)l.set(h,s.slice(e,e+u));const f=[];a.forEach(((e,t)=>{const i=r[t],s=[...l.get(e),i];f.push(...s)}));const d=new Float32Array(f);this.faceBuffer=e.createBuffer({label:"vertex buffer per face",size:n(d.byteLength),mappedAtCreation:!0,usage:window.GPUBufferUsage.VERTEX|window.GPUBufferUsage.COPY_DST});new Float32Array(this.faceBuffer.getMappedRange()).set(new Float32Array(d,0,this.faceBuffer.byteLength)),this.faceBuffer.unmap(),this.faceDrawCount=o}};const u=class{constructor(){(0,s.A)(this,"getBindGroups",(()=>this.bindGroups)),(0,s.A)(this,"getBindGroup",(e=>this.bindGroups.get(e))),this.bindGroups=new Map}async setup(e,t,r,i,s){if(0===r.size)throw new Error("No materials found");const a=await this.setupEmptyTexture(e);let n=0;for(const[o,u]of r){const r=[{binding:0,resource:{buffer:this.setupUniformsBuffer(e,u)}}];if(u.pbrMetallicRoughness.baseColorTexture){const t=i.get(u.pbrMetallicRoughness.baseColorTexture.index),{sampler:s,textureView:a}=this.setupTexture(e,t);r.push({binding:1,resource:s},{binding:2,resource:a})}else r.push({binding:1,resource:a.sampler},{binding:2,resource:a.textureView});s&&r.push(...s),this.bindGroups.set(n,e.createBindGroup({label:"bind group material",layout:t,entries:r})),n++}}setupUniformsBuffer(e,t){const r=e.createBuffer({size:12*Float32Array.BYTES_PER_ELEMENT,usage:window.GPUBufferUsage.UNIFORM|window.GPUBufferUsage.COPY_DST,mappedAtCreation:!0}),i=new Float32Array(r.getMappedRange()),s=[...t.pbrMetallicRoughness?.baseColorFactor||[1,1,1,1],...t.emissiveFactor||[1,1,1],t.pbrMetallicRoughness?.metallicFactor??.5,t.pbrMetallicRoughness?.roughnessFactor??.5];return i.set(s),r.unmap(),r}setupTexture(e,t){const r=[t.imageData.width,t.imageData.height],i=e.createTexture({label:"Material base color texture",size:r,format:"rgba8unorm",usage:GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_DST|GPUTextureUsage.RENDER_ATTACHMENT});return e.queue.copyExternalImageToTexture({source:t.imageData},{texture:i},r),{sampler:e.createSampler({addressModeU:"repeat",addressModeV:"repeat",magFilter:"linear",minFilter:"nearest",mipmapFilter:"nearest",maxAnisotropy:1}),textureView:i.createView({format:"rgba8unorm",dimension:"2d",aspect:"all"})}}async setupEmptyTexture(e){const t=new ImageData(1,1);t.data[0]=255,t.data[1]=0,t.data[2]=0,t.data[3]=255;const r=await createImageBitmap(t),i=[t.width,t.height],s=e.createTexture({label:"Material empty texture",size:i,format:"rgba8unorm",usage:GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_DST|GPUTextureUsage.RENDER_ATTACHMENT});return e.queue.copyExternalImageToTexture({source:r},{texture:s},i),{sampler:e.createSampler(),textureView:s.createView()}}};var l,h=r(67269),f=r(7567);class d{constructor(){this.name="Transform"}}l=d,(0,s.A)(d,"get",(e=>l.handleLocalTransform(e))),(0,s.A)(d,"getNormalMatrix",(e=>{const t=e.getMatrice3x3();return t.inverse(),t.transpose(),t})),(0,s.A)(d,"handleLocalTransform",(e=>{const{translation:t,rotation:r,scale:i,matrix:s}=e,a=new h.A;return a.identity(),i&&a.scale(...i),r&&a.multiply(new f.A(...r).toMatrix4()),t&&a.translate(...t),s&&a.multiplyArray(s),a}));const c=d;const p=class{constructor(){this.name="BufferTransform",this.buffer=null,this.bindGroup=null}setup(e,t,r){this.buffer=e.createBuffer({size:16*Float32Array.BYTES_PER_ELEMENT*2,usage:window.GPUBufferUsage.UNIFORM|window.GPUBufferUsage.COPY_DST});const i=[{binding:0,resource:{buffer:this.buffer}}];r&&i.push({binding:1,resource:{buffer:r.get()}}),this.bindGroup=e.createBindGroup({label:"NodeTransformBindGroup",layout:t,entries:i})}update(e,t){const{transformMatrix:r,pickingColor:i}=t,s=c.getNormalMatrix(r).get(),a=[s[0],s[1],s[2],0,s[3],s[4],s[5],0,s[6],s[7],s[8],0],n=[...r.get(),...a,...i??[]];e.queue.writeBuffer(this.buffer,0,new Float32Array(n))}getBuffer(){return this.buffer}getBindGroup(){return this.bindGroup}};var g=r(1753),m=r(67998),b=r(3195);const T={color:{srcFactor:"src-alpha",dstFactor:"one-minus-src-alpha"},alpha:{srcFactor:"one",dstFactor:"one"}},x={CAMERA:0,TRANSFORM:1,MATERIAL:2,LIGHT:3},w=(e,t)=>{let{withShadow:r=!1,withSkin:i=!1}=t;const s=[{binding:0,visibility:GPUShaderStage.VERTEX,buffer:{type:"uniform",hasDynamicOffset:!1,minBindingSize:208}}];r&&s.push({binding:1,visibility:GPUShaderStage.VERTEX,buffer:{type:"uniform",hasDynamicOffset:!1}});const a=e.createBindGroupLayout({label:"Camera Uniform Bind Group Layout",entries:s}),n=[{binding:0,visibility:GPUShaderStage.VERTEX,buffer:{type:"uniform",hasDynamicOffset:!1}}];i&&n.push({binding:1,visibility:GPUShaderStage.VERTEX,buffer:{type:"uniform",hasDynamicOffset:!1}});const o=e.createBindGroupLayout({label:"Transform Uniform Bind Group Layout",entries:n}),u=[{binding:0,visibility:GPUShaderStage.FRAGMENT,buffer:{type:"uniform",hasDynamicOffset:!1,minBindingSize:48}},{binding:1,visibility:GPUShaderStage.FRAGMENT,sampler:{}},{binding:2,visibility:GPUShaderStage.FRAGMENT,texture:{}}];r&&u.push({binding:3,visibility:GPUShaderStage.FRAGMENT,buffer:{type:"uniform"}},{binding:4,visibility:GPUShaderStage.FRAGMENT,sampler:{type:"comparison"}},{binding:5,visibility:GPUShaderStage.FRAGMENT,texture:{sampleType:"depth",viewDimension:"2d"}});const l=e.createBindGroupLayout({label:"Material Uniform Bind Group Layout",entries:u}),h=e.createBindGroupLayout({label:"Lights Storage Bind Group Layout",entries:[{binding:0,visibility:GPUShaderStage.FRAGMENT,buffer:{type:"read-only-storage",hasDynamicOffset:!1,minBindingSize:0}}]});return{[x.CAMERA]:a,[x.TRANSFORM]:o,[x.MATERIAL]:l,[x.LIGHT]:h}},A=e=>[e.createBindGroupLayout({label:"Shadow Camera Uniform Bind Group Layout",entries:[{binding:0,visibility:GPUShaderStage.VERTEX|GPUShaderStage.FRAGMENT,buffer:{type:"uniform",hasDynamicOffset:!1,minBindingSize:208}}]}),e.createBindGroupLayout({label:"Shadow Transform Uniform Bind Group Layout",entries:[{binding:0,visibility:GPUShaderStage.VERTEX,buffer:{type:"uniform",hasDynamicOffset:!1,minBindingSize:112}}]})],y=e=>[e.createBindGroupLayout({label:"Picking Camera Uniform Bind Group Layout",entries:[{binding:0,visibility:GPUShaderStage.VERTEX|GPUShaderStage.FRAGMENT,buffer:{type:"uniform",hasDynamicOffset:!1,minBindingSize:208}}]}),e.createBindGroupLayout({label:"Picking Transform Uniform Bind Group Layout",entries:[{binding:0,visibility:GPUShaderStage.VERTEX,buffer:{type:"uniform",hasDynamicOffset:!1,minBindingSize:128}}]})];class P{constructor(e){(0,s.A)(this,"setup",(async e=>{const t=new Float32Array(b.A.position),r=this.context.getDevice();this.buffers.vertex=r.createBuffer({label:"debug vertex buffer",size:4*Math.ceil(t.byteLength/4),mappedAtCreation:!0,usage:window.GPUBufferUsage.VERTEX|window.GPUBufferUsage.COPY_DST});new Float32Array(this.buffers.vertex.getMappedRange()).set(t),this.buffers.vertex.unmap();const i=new Uint16Array(b.A.indices);this.buffers.index=r.createBuffer({label:"debug index buffer",size:4*Math.ceil(i.byteLength/4),mappedAtCreation:!0,usage:window.GPUBufferUsage.INDEX|window.GPUBufferUsage.COPY_DST});new Uint16Array(this.buffers.index.getMappedRange()).set(i),this.buffers.index.unmap(),this.pipeline=await r.createRenderPipelineAsync({label:"Debug pipeline",layout:"auto",vertex:{module:e.vertex,entryPoint:"v_main",buffers:[{arrayStride:3*Float32Array.BYTES_PER_ELEMENT,attributes:[{format:"float32x3",offset:0,shaderLocation:0}]}]},fragment:{module:e.fragment,entryPoint:"f_main",targets:[{format:"bgra8unorm",blend:T}]},primitive:{topology:"triangle-list",cullMode:"back"},depthStencil:{depthWriteEnabled:!0,depthCompare:"less",format:"depth32float"},multisample:{count:this.sampleCount}}),this.setTransform(0,0,0)})),(0,s.A)(this,"render",((e,t)=>{e.setPipeline(this.pipeline),e.setBindGroup(x.CAMERA,t),e.setBindGroup(x.TRANSFORM,this.transformUniformBindGroup),e.setVertexBuffer(0,this.buffers.vertex),e.setIndexBuffer(this.buffers.index,"uint16"),e.drawIndexed(b.A.indices.length)})),(0,s.A)(this,"getBindGroupLayout",(e=>this.pipeline.getBindGroupLayout(e))),this.context=e,this.pipeline=void 0,this.buffers={vertex:void 0,index:void 0},this.transformUniformBindGroup=void 0,this.renderPassDescriptor=void 0,this.sampleCount=4}setTransform(e,t,r){const i=this.context.getDevice(),s=i.createBuffer({size:16*Float32Array.BYTES_PER_ELEMENT,usage:window.GPUBufferUsage.UNIFORM|window.GPUBufferUsage.COPY_DST,mappedAtCreation:!0}),a=new Float32Array(s.getMappedRange()),n=new h.A;n.identity().scale(.1).translate(e,t,r),a.set(n.get()),s.unmap(),this.transformUniformBindGroup=i.createBindGroup({label:"debug bind group transform",layout:this.pipeline.getBindGroupLayout(x.TRANSFORM),entries:[{binding:0,resource:{buffer:s}}]})}}class B{constructor(e){this.context=e,this.depthTextureFormat="depth32float",this.size={width:5,height:7}}setup(e,t){this.size=t;const r=this.context.getDevice(),i=r.createBindGroupLayout({label:"unfilterable-bgl",entries:[{binding:0,visibility:GPUShaderStage.FRAGMENT,sampler:{type:"non-filtering"}},{binding:1,visibility:GPUShaderStage.FRAGMENT,texture:{sampleType:"unfilterable-float"}}]});this.pipeline=r.createRenderPipeline({label:"DebugTexturePipeline",layout:r.createPipelineLayout({bindGroupLayouts:[i]}),vertex:{module:e.vertex,entryPoint:"v_main"},fragment:{module:e.fragment,entryPoint:"f_main",targets:[{format:this.context.getCanvasFormat(),blend:T}]},depthStencil:{depthWriteEnabled:!0,depthCompare:"less",format:this.depthTextureFormat},multisample:{count:4}})}setData(){const e=[255,0,0,255],t=[255,255,0,255],r=[0,0,255,255],i=()=>[e,t,r][Math.floor(3*Math.random())];return new Uint8Array(Array.from({length:this.size.height}).map((()=>Array.from({length:this.size.width}).map(i))).flat(2))}setTexture(e){const t=this.context.getDevice();this.bindGroup=t.createBindGroup({label:"debug texture bind group",layout:this.pipeline.getBindGroupLayout(0),entries:[{binding:0,resource:t.createSampler()},{binding:1,resource:e.createView()}]})}updateTexture(){this.context.getDevice().queue.writeTexture({texture:this.texture},this.setData(),{bytesPerRow:4*this.size.width},this.size)}render(e){e.setPipeline(this.pipeline),e.setBindGroup(0,this.bindGroup),e.draw(6)}}const E=class{constructor(){(0,s.A)(this,"get",(()=>this.device)),(0,s.A)(this,"getEncodeur",(()=>this.encoder)),this.device=null,this.encoder=null}async setup(e){this.device=await e.requestDevice(),this.encoder=this.device.createCommandEncoder()}};var G=r(67470),v=r(4689),U=r(40117);class M{constructor(e,t){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;(0,s.A)(this,"addAllAnimations",((e,t,r)=>{for(const[i,s]of e){const e=t.get(i);this.nodeTramsforms.set(i,{scale:e.scale,rotation:e.rotation,translation:e.translation}),this.animations.set(i,this.addAnimations(s,r))}})),(0,s.A)(this,"addAnimations",((e,t)=>{const r=new Map;return e.forEach((e=>{let{path:i,times:s,output:a,interpolation:n}=e,o=null!==t?a[t]:a[0];"rotation"===i&&(o=new f.A(...o).toMatrix4()),this.animationInterval[1]=Math.max(...s,this.animationInterval[1]),r.set(i,{output:a,sample:new U.A(s,n,this.speedAnimation),customStep:t,value:o})})),r})),(0,s.A)(this,"update",(e=>{const t=e-this.lastFrame;t>this.animationInterval[1]*this.speedAnimation&&(this.lastFrame=e),this.updateAnimations(t)})),(0,s.A)(this,"updateAnimations",(e=>{for(const[t,r]of this.animations){const i=new Map;for(const[t,s]of r)"rotation"===t?i.set(t,M.updateQuat(s,e)):i.set(t,M.updateVector(s,e));this.animations.set(t,i)}})),(0,s.A)(this,"handleLocalTransform",(e=>{const t=this.nodeTramsforms.get(e);if(!t)return(new h.A).identity();const{translation:r,rotation:i,scale:s}=t,a=this.animations.get(e),n=a?.get("rotation")||null,o=a?.get("translation")||null,u=a?.get("scale")||null,l=new h.A;return l.identity(),(s||u)&&l.scale(...M.getVector(s,u)),(i||n)&&l.multiply(M.getRotationMat(i,n)),(r||o)&&l.translate(...M.getVector(r,o)),l})),(0,s.A)(this,"setAnimationStep",((e,t,r)=>{const i=this.animations[e][t],s=i.output.length,a=(0,v.cy)(r,0,1,0,s-1);i.customStep=Math.round(a)})),(0,s.A)(this,"setAnimationSpeed",((e,t,r)=>{this.animations[e][t].sample.setSpeed(r)})),(0,s.A)(this,"isNodeHasAnimation",(e=>this.animations.has(e))),this.speedAnimation=2e3,this.animationInterval=[0,0],this.animations=new Map,this.nodeTramsforms=new Map,this.lastFrame=0,this.addAllAnimations(e,t,r)}hasAnim(e){return void 0!==this.nodeTramsforms.get(e)}}(0,s.A)(M,"updateVector",((e,t)=>{const r=e,{sample:i,customStep:s,output:a}=r;if(null===s){i.update(t);const e=i.getIndex();if(0===e)[r.value]=a;else if(e>a.length-1)r.value=a[a.length-1];else{const t=a[e-1],s=a[e],n=i.get();r.value=t.map(((e,t)=>(0,G.Cc)(n,e,s[t])))}}else r.value=a[s];return r})),(0,s.A)(M,"updateQuat",((e,t)=>{const r=e,{sample:i,customStep:s,output:a}=r;if(null===s){i.update(t);const e=i.getIndex();if(0===e)r.value=new f.A(...a[0]).toMatrix4();else if(e>a.length-1)r.value=new f.A(...a[a.length-1]).toMatrix4();else{const t=a[e-1],s=a[e],n=i.get();r.value=f.A.slerpArray(t,s,n).toMatrix4()}}else r.value=new f.A(...a[s]).toMatrix4();return r})),(0,s.A)(M,"getVector",(function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[0,0,0],t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;return t?.value?t.value:e})),(0,s.A)(M,"getRotationMat",(function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[0,0,0,1],t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;return t?.value?t.value:new f.A(...e).toMatrix4()}));const S=M;class R{constructor(){this.buffer=null,this.joints=null}setup(e,t){this.joints=t,this.buffer=e.createBuffer({label:"skin joint matrices buffer",size:400*Float32Array.BYTES_PER_ELEMENT,usage:window.GPUBufferUsage.UNIFORM|window.GPUBufferUsage.COPY_DST}),this.uniformValues=new Float32Array(400)}computeJointMatrix(e,t,r){let i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};const s=[];for(const a of e){const e=r?.hasAnim(a.id)??!1?r?.handleLocalTransform(a.id):c.handleLocalTransform(a);e.multiply(t),i[a.name]&&e.multiply(i[a.name]);const n=new h.A;n.setFromArray(a.invMatrix);const o=new h.A;if(o.identity(),o.multiply(n),o.multiply(e),s.push(o.get()),a.children){const t=this.computeJointMatrix(a.children,e,r,i);s.push(...t)}}return s}update(e,t){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};const i=new h.A;i.identity();const s=this.computeJointMatrix(this.joints,i,t,r).flat();this.uniformValues.fill(0),this.uniformValues.set(s.slice(0,this.uniformValues.length)),e.queue.writeBuffer(this.buffer,0,this.uniformValues.buffer,this.uniformValues.byteOffset,this.uniformValues.byteLength)}get(){return this.buffer}}var C=r(69194);class D{constructor(e){(0,s.A)(this,"render",(e=>{const t=this.context.getDevice(),r=t.createCommandEncoder({label:"PickingCommandEncoder"});this.renderPassDescriptor.colorAttachments[0].view=this.colorTexture.createView(),this.renderPassDescriptor.depthStencilAttachment.view=this.depthTexture.createView();const i=r.beginRenderPass(this.renderPassDescriptor);i.setPipeline(this.pipeline),i.setBindGroup(x.CAMERA,e),this.drawModel&&this.drawModel(t,i),i.end(),t.queue.submit([r.finish()])})),(0,s.A)(this,"pick",(async(e,t,r,i)=>{const s=this.context.getDevice(),a=s.createCommandEncoder({label:"PickingCommandEncoder"});this.renderPassDescriptor.colorAttachments[0].view=this.colorTexture.createView(),this.renderPassDescriptor.depthStencilAttachment.view=this.depthTexture.createView();const n=a.beginRenderPass(this.renderPassDescriptor);n.setPipeline(this.pipeline),n.setBindGroup(x.CAMERA,t),this.drawModel(s,n,r,i),n.end();const o=await this.capturePixel(e,a);return s.queue.submit([a.finish()]),o})),(0,s.A)(this,"capturePixel",(async(e,t)=>{t.copyTextureToBuffer({texture:this.colorTexture,origin:e},{buffer:this.destinationBuffer,bytesPerRow:256},{width:1,height:1}),await this.destinationBuffer.mapAsync(GPUMapMode.READ,0,this.bufferSize);const r=[...new Float32Array(this.destinationBuffer.getMappedRange(0,this.bufferSize))];return this.destinationBuffer.unmap(),[N(r[0]),N(r[1]),0,1]})),(0,s.A)(this,"drawModel",((e,t,r,i)=>{for(const[e,i]of r)i.buffers.forEach((r=>{const{hasAnimation:i,transform:s}=this.transformBinGroups.get(e);i||(t.setBindGroup(x.TRANSFORM,s.getBindGroup()),t.setVertexBuffer(0,r.getFaceBuffer()),t.draw(r.getFaceBufferCount()))}))})),(0,s.A)(this,"resize",(e=>{this.textures.resize(this.context.getDevice(),this.context.getCanvasFormat(),e),this.createTexture(e),this.texSize=e})),(0,s.A)(this,"getBindGroupLayout",(e=>this.pipeline.getBindGroupLayout(e))),(0,s.A)(this,"getColorTexture",(()=>this.colorTexture)),this.context=e,this.bufferSize=16,this.pipeline=void 0,this.colorTexture=void 0,this.textures=new C.A,this.texSize={width:1,height:1}}createTexture(e){const t=this.context.getDevice();this.colorTexture=t.createTexture({label:"picking texture",format:"rgba32float",size:e,usage:GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.COPY_SRC}),this.depthTexture=t.createTexture({label:"picking depth texture",format:"depth32float",size:e,usage:GPUTextureUsage.RENDER_ATTACHMENT})}async setup(e,t,r){const i=this.context.getDevice(),s=[{arrayStride:r[0].arrayStride+Float32Array.BYTES_PER_ELEMENT,attributes:[...r[0].attributes,{format:"float32",offset:32,shaderLocation:3}]}],a=y(i);this.pipeline=await i.createRenderPipelineAsync({label:"PickingPipeline",layout:i.createPipelineLayout({label:"Picking Pipeline layout",bindGroupLayouts:[a[x.CAMERA],a[x.TRANSFORM]]}),vertex:{module:e.vertex,entryPoint:"v_main",buffers:s},fragment:{module:e.fragment,entryPoint:"f_main",targets:[{format:"rgba32float"}]},primitive:{topology:"triangle-list",cullMode:"back"},depthStencil:{depthWriteEnabled:!0,depthCompare:"less",format:"depth32float"}}),this.createTexture(this.texSize),this.destinationBuffer=i.createBuffer({label:"PickDestination",size:this.bufferSize,usage:GPUBufferUsage.COPY_DST|GPUBufferUsage.MAP_READ}),this.renderPassDescriptor={label:"MousePickRenderPass",colorAttachments:[{view:null,clearValue:{r:0,g:0,b:0,a:0},loadOp:"clear",storeOp:"store"}],depthStencilAttachment:{view:null,depthClearValue:1,depthLoadOp:"clear",depthStoreOp:"store",stencilClearValue:0}},this.textures.setup(i,this.context.getCanvasFormat(),t)}setDrawModel(e){this.drawModel=e}setTransformBindGroups(e){this.transformBinGroups=e}}const F=1e-6,L=e=>N(F+e*F),N=e=>Number.parseFloat(e).toFixed(6);const V=class{constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:4,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"depth32float";(0,s.A)(this,"setupRenderPassDescriptor",(()=>{this.renderPassDescriptor={label:"Gltf Pass Descriptor",colorAttachments:[{view:null,resolveTarget:null,clearValue:{r:0,g:0,b:0,a:0},loadOp:"clear",storeOp:"store"}],depthStencilAttachment:{view:null,depthClearValue:1,depthLoadOp:"clear",depthStoreOp:"store",stencilClearValue:0}}})),(0,s.A)(this,"update",((e,t,r)=>{this.renderPassDescriptor.colorAttachments[0].resolveTarget=e,this.renderPassDescriptor.colorAttachments[0].view=t,this.renderPassDescriptor.depthStencilAttachment.view=r})),(0,s.A)(this,"get",(()=>this.pipeline)),(0,s.A)(this,"getRenderPassDescriptor",(()=>this.renderPassDescriptor)),(0,s.A)(this,"getDepthTextureFormat",(()=>this.depthTextureFormat)),this.pipeline=null,this.renderPassDescriptor=null,this.depthTextureFormat=t,this.sampleCount=e}async setup(e,t,r,i,s,a){const n={label:"Gltf pipeline",layout:e.createPipelineLayout({label:"Pipeline layout",bindGroupLayouts:a}),vertex:{module:t.vertex,entryPoint:"v_main",buffers:i},fragment:{module:t.fragment,entryPoint:"f_main",targets:[{format:s,blend:T}]},primitive:r,depthStencil:{depthWriteEnabled:!0,depthCompare:"less",format:this.depthTextureFormat},multisample:{count:this.sampleCount}};this.pipeline=await e.createRenderPipelineAsync(n)}};class _{constructor(e,t){var r=this;(0,s.A)(this,"drawModel",(function(e,t){let i=arguments.length>2&&void 0!==arguments[2]&&arguments[2];for(const[s,a]of r.nodesToDraw)a.skinBuffer?.update(e,r.animations,r.customTransforms),a.buffers.forEach((n=>{const{hasAnimation:o,transform:u}=r.transformBindGroups.get(s);if(o){const t=r.getAbsoluteAnimatedMatrix(s);u.update(e,{transformMatrix:t,pickingColor:i?a.pickingColor:void 0})}t.setBindGroup(x.TRANSFORM,u.getBindGroup()),t.setBindGroup(x.MATERIAL,r.materialBuffer.getBindGroup(r.materialIndexes.get(n)||0)),i?(t.setVertexBuffer(0,n.getFaceBuffer()),t.draw(n.getFaceBufferCount())):(t.setVertexBuffer(0,n.getVertexBuffer()),t.setIndexBuffer(n.getIndexBuffer(),"uint16"),t.drawIndexed(n.getIndexCount(),1,0))}))})),(0,s.A)(this,"resize",(e=>{this.textures.resize(this.context.getDevice(),this.context.getCanvasFormat(),e)})),(0,s.A)(this,"getBindGroupLayout",(e=>this.bindGroupLayouts[e])),(0,s.A)(this,"getRenderPassDescriptor",(()=>this.pipeline.getRenderPassDescriptor())),(0,s.A)(this,"get",(()=>this.pipeline.get())),(0,s.A)(this,"getDrawNodes",(()=>this.nodesToDraw)),(0,s.A)(this,"getAnimations",(()=>this.animations)),(0,s.A)(this,"getFirstBufferLayout",(()=>this.firstBufferLayout)),(0,s.A)(this,"getByPickColor",(async e=>{const t=this.nodesPerColorPicking.get(e[0]),r=this.nodes.get(t);this.nodesToDraw.get(t);let i,s;if(r){const t=await this.db.getMeshMatrixData(r.mesh);if(t){const e=t.matrix;s=new h.A,s.setRaw(e)}const a=this.facesPerMeshPerColorPicking.get(r.mesh);if(a){const t=a.get(e[1]),s=await this.db.getMeshFaceData(`${r.mesh}-${t}`);s&&(i=s.vertices)}}return{positions:i,node:r,matrix:s}})),this.context=e,this.config=t,this.pipeline=new V,this.textures=new C.A,this.customTransforms={},this.db=null}async setupDb(e){this.db=e,await this.db.setup()}async setup(e,t,r,i){let s=arguments.length>4&&void 0!==arguments[4]&&arguments[4];const a=this.context.getDevice(),n=e.get("nodes");this.nodes=n,this.matrixBuffersMaps=new Map,this.materialIndexes=new Map;const l=new Map;this.facesPerMeshPerColorPicking=new Map;const h=[];for(const[t,r]of e.get("meshes")){const e=[],i=new Map;let s=0;for(const n of r.primitives){const u=new o;u.setup(a,n,r.name),this.materialIndexes.set(u,n.material),e.push(u);const l=n.bufferIndex.length/3,f=[],d=this.db?_.getIndiceVerticesMap(n):null;for(let e=0;e<l;e++){if(d){const r=3*e,i=n.bufferIndex.at(r),a=n.bufferIndex.at(r+1),o=n.bufferIndex.at(r+2),u=d.get(i),l=d.get(a),f=d.get(o);h.push({meshIdIndex:`${t}-${s}`,vertices:[u,l,f]})}const r=L(s);i.set(r,s),s++;const a=Number.parseFloat(r);f.push(a,a,a)}u.setupForFaces(a,n,f),u.setupFaceColorPick(a,[0,0,0,0])}this.facesPerMeshPerColorPicking.set(t,i),l.set(t,e)}this.db&&h.length&&await this.db.addFacesData(h);const f=l.values().next().value[0];this.firstBufferLayout=f.getLayout();let d=[this.firstBufferLayout];s&&(d=[{arrayStride:this.firstBufferLayout.arrayStride+Float32Array.BYTES_PER_ELEMENT,attributes:[...this.firstBufferLayout.attributes,{format:"float32",offset:32,shaderLocation:3}]}]),this.bindGroupLayouts=w(a,{withSkin:!!e.get("skins"),withShadow:void 0!==i}),await this.pipeline.setup(a,t,e.get("pipeline"),d,this.context.getCanvasFormat(),[this.bindGroupLayouts[x.CAMERA],this.bindGroupLayouts[x.TRANSFORM],this.bindGroupLayouts[x.MATERIAL],this.bindGroupLayouts[x.LIGHT]]),this.pipeline.setupRenderPassDescriptor(),this.animations=new S(e.get("animations"),n),this.materialBuffer=new u,await this.materialBuffer.setup(a,this.getBindGroupLayout(x.MATERIAL),e.get("materials"),e.get("textures"),i),this.buildDrawNodes(a,n,l,e.get("skins")),this.transformBindGroups=this.buildTransformBindGroups(this.getBindGroupLayout(x.TRANSFORM)),this.textures.setup(a,this.context.getCanvasFormat(),r);const c=this.db?[]:null;if(c){for(const[e,t]of this.nodesToDraw)c.push({meshId:e,matrix:t.matrix.get()});await this.db.addNodeMatricesData(c)}}static getIndiceVerticesMap(e){const t=new Map,r=e.arrayStride/Float32Array.BYTES_PER_ELEMENT,i=e.bufferVertex.length/r;for(let s=0;s<i;s++){const i=s*r,a=[e.bufferVertex.at(i),e.bufferVertex.at(i+1),e.bufferVertex.at(i+2)];t.set(s,a)}return t}static getAbsoluteMatrix(e,t){const r=t.get(e);if(!r)throw Error("node not found in getAbsoluteMatrix");if(r.parent){const e=c.get(r);return r.paths.forEach((r=>{const i=t.get(r),s=c.get(i);e.multiply(s)})),e}return c.get(r)}getAbsoluteAnimatedMatrix(e){const t=this.nodes.get(e);if(!t)throw Error("node not found in getAbsoluteMatrix");if(t.parent){const e=c.get(t);return t.paths.forEach((t=>{if(this.animations.isNodeHasAnimation(t)){const r=this.animations.handleLocalTransform(t);e.multiply(r)}else{const r=this.nodes.get(t),i=c.get(r);e.multiply(i)}})),e}return this.animations.isNodeHasAnimation(e)?this.animations.handleLocalTransform(e):c.get(t)}static getMeshId(e,t){if(e.isInstance){return t.get(e.children[0]).mesh}return e.mesh}buildDrawNodes(e,t,r,i){this.nodesToDraw=new Map,this.nodesPerColorPicking=new Map;let s=0;for(const[a,n]of t){const o=_.getMeshId(n,t);if(void 0===o||n.isInstanceRef||!n.isInstance&&n.children)continue;const u=_.getAbsoluteMatrix(a,t),l=r.get(o),h=this.animations.isNodeHasAnimation(a)||n.paths?.some(this.animations.isNodeHasAnimation),f=L(s);let d=null;if(void 0!==n.skin){const t=i.get(n.skin);if(t){const{joints:r}=t;d=new R,d.setup(e,r)}}this.nodesToDraw.set(a,{name:n.name,buffers:l,matrix:u,pickingColor:[Number.parseFloat(f),0,0,1],hasAnimation:h,skinBuffer:d}),this.nodesPerColorPicking.set(f,a),s++}}buildTransformBindGroups(e){const t=this.context.getDevice(),r=new Map;for(const[i,s]of this.nodesToDraw){const a=new p;a.setup(t,e,s.skinBuffer),r.set(i,{transform:a,hasAnimation:s.hasAnimation}),s.hasAnimation||a.update(t,{transformMatrix:s.matrix,pickingColor:s.pickingColor})}return r}updateAnimations(e){this.animations&&this.animations.update(e)}update(){this.pipeline.update(this.context.getCurrentTexture().createView(),this.textures.getRenderTargetView(),this.textures.getDepthTextureView())}getNodeAbsoluteMatrix(e){return this.nodesToDraw.get(e).matrix}setCustomTransform(e,t){this.customTransforms[e]=t}}var I=r(44425),O=r(65304);class z{constructor(e){(0,s.A)(this,"render",((e,t,r)=>{const i=this.context.getDevice(),s=i.createCommandEncoder({label:"ShadowCommandEncoder"}),a=s.beginRenderPass(this.renderPassDescriptor);a.setPipeline(this.pipeline),a.setBindGroup(x.CAMERA,e),this.drawModel(i,a,t,r),a.end(),i.queue.submit([s.finish()])})),(0,s.A)(this,"drawModel",((e,t,r,i)=>{for(const[e,i]of r)i.buffers.forEach((r=>{const{hasAnimation:i,transform:s}=this.transformBinGroups.get(e);i||(t.setBindGroup(x.TRANSFORM,s.getBindGroup()),t.setVertexBuffer(0,r.getVertexBuffer()),t.setVertexBuffer(1,r.getFaceColorBuffer()),t.setIndexBuffer(r.getIndexBuffer(),"uint16"),t.drawIndexed(r.getIndexCount()))}))})),(0,s.A)(this,"getBindGroupLayout",(e=>this.pipeline.getBindGroupLayout(e))),(0,s.A)(this,"getDepthTexture",(()=>this.depthTexture)),(0,s.A)(this,"getDepthTextureView",(()=>this.textureDepthView)),(0,s.A)(this,"getSize",(()=>this.texSize)),this.context=e,this.pipeline=void 0,this.texSize={width:2048,height:2048},this.textureDepthView}async setup(e){const t=this.context.getDevice(),r=A(t);this.pipeline=await t.createRenderPipelineAsync({label:"ShadowPipeline",layout:t.createPipelineLayout({label:"Shadow Pipeline layout",bindGroupLayouts:r}),vertex:{module:e.vertex,entryPoint:"v_main",buffers:[{arrayStride:32,attributes:[{shaderLocation:0,format:"float32x3",offset:0},{shaderLocation:1,format:"float32x3",offset:12},{shaderLocation:2,format:"float32x2",offset:24}]}]},primitive:{topology:"triangle-list",cullMode:"back"},depthStencil:{depthWriteEnabled:!0,depthCompare:"less",format:"depth32float"}}),this.depthTexture=t.createTexture({label:"shadow depth texture",size:{width:2048,height:2048,depthOrArrayLayers:1},format:"depth32float",usage:GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.TEXTURE_BINDING}),this.textureDepthView=this.depthTexture.createView({dimension:"2d",format:"depth32float",aspect:"depth-only"}),this.renderPassDescriptor={label:"Shadow render pass",colorAttachments:[],depthStencilAttachment:{view:this.textureDepthView,depthClearValue:1,depthLoadOp:"clear",depthStoreOp:"store",stencilClearValue:0}}}setTransformBindGroups(e){this.transformBinGroups=e}getShadowMapBindGroupEntries(e,t){const r=e.createBuffer({label:"LightPositionBuffer",size:3*Float32Array.BYTES_PER_ELEMENT,usage:window.GPUBufferUsage.UNIFORM|window.GPUBufferUsage.COPY_DST,mappedAtCreation:!0});return new Float32Array(r.getMappedRange()).set(t),r.unmap(),[{binding:3,resource:{buffer:r}},{binding:4,resource:e.createSampler({magFilter:"nearest",minFilter:"nearest",mipmapFilter:"nearest",compare:"less",addressModeU:"clamp-to-edge",addressModeV:"clamp-to-edge",addressModeW:"clamp-to-edge"})},{binding:5,resource:this.textureDepthView}]}}var k=r(15142)},44425(e,t,r){r.d(t,{w:()=>s});var i=r(54705);class s{constructor(e){(0,i.A)(this,"resize",((e,t)=>{this.canvasSize=t,this.renderTargets?.forEach((e=>{e.destroy()})),this.setupRenderTextures(e,t),this.pingTarget?.destroy(),this.pongTarget?.destroy(),this.setupPingPongTargets(e,t);let r=0;for(const[e,t]of this.effects)this.setupEffectSource(e,this.getPingPongTexture(r%2==0).createView()),r++})),this.context=e,this.pipeline=void 0,this.renderTargetFormat=navigator.gpu.getPreferredCanvasFormat(),this.presentationFormat=navigator.gpu.getPreferredCanvasFormat(),this.sampleCount=1,this.renderTargetsCount=3,this.effectRenderGroups=new Map,this.canvasSize={width:1,height:1},this.effects=new Map}setup(e){const t=this.context.getDevice();this.pipeline=t.createRenderPipeline({label:"post process no attributes",layout:"auto",vertex:{module:e},fragment:{module:e,targets:[{format:this.renderTargetFormat}]},multisample:{count:this.sampleCount}}),this.sampler=t.createSampler({minFilter:"linear",magFilter:"linear"}),this.renderPassDescriptor={label:"post process render pass",colorAttachments:[{loadOp:"clear",storeOp:"store"}]}}setupRenderTextures(e,t){this.renderTargets=Array.from({length:this.renderTargetsCount}).map(((r,i)=>e.createTexture({label:`post process render target ${i}`,size:t,format:this.renderTargetFormat,sampleCount:this.sampleCount,usage:GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.TEXTURE_BINDING}))),this.renderTargetViews=this.renderTargets.map((e=>e.createView())),this.bindGroup=e.createBindGroup({label:"post process bind group",layout:this.pipeline.getBindGroupLayout(0),entries:[{binding:0,resource:this.sampler},...this.renderTargets.map(((e,t)=>({binding:t+1,resource:this.renderTargetViews[t]})))]})}setupPingPongTargets(e,t){this.pingTarget=e.createTexture({label:"ping render target",size:t,format:this.renderTargetFormat,sampleCount:this.sampleCount,usage:GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.TEXTURE_BINDING}),this.pongTarget=e.createTexture({label:"pong render target",size:t,format:this.renderTargetFormat,sampleCount:this.sampleCount,usage:GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.TEXTURE_BINDING})}addEffect(e,t){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};const i=this.context.getDevice();this.effects.set(e,{pipeline:i.createRenderPipeline({label:`post process ${e} no attributes`,layout:"auto",vertex:{module:t},fragment:{module:t,targets:[{format:this.presentationFormat}]},multisample:{count:this.sampleCount}}),passDescriptor:{label:`post process ${e}`,colorAttachments:[{loadOp:"clear",storeOp:"store"}]},params:r})}setupEffectSource(e,t){const r=this.context.getDevice();let i={};const s=[{binding:0,resource:this.sampler},{binding:1,resource:t}];switch(e){case"guassianBlurVertical":case"guassianBlurHorizontal":{const e=[1/this.canvasSize.width,1/this.canvasSize.height],t=r.createBuffer({label:"radius buffer",size:8,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}),a=r.createBuffer({label:"direction buffer",size:8,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}),n=r.createBuffer({label:"texel size buffer",size:8,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST});r.queue.writeBuffer(n,0,new Float32Array(e)),s.push({binding:2,resource:{buffer:a}},{binding:3,resource:{buffer:n}},{binding:4,resource:{buffer:t}}),i={radius:t,direction:a};break}case"bright":{const e=r.createBuffer({label:"threshold buffer",size:8,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}),t=r.createBuffer({label:"glow threshold knee buffer",size:8,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST});s.push({binding:2,resource:{buffer:e}},{binding:3,resource:{buffer:t}}),i={threshold:e,glowThresholdKnee:t};break}}this.effects.set(e,{...this.effects.get(e),bindGroup:r.createBindGroup({label:`Group for ${e}`,layout:this.effects.get(e).pipeline.getBindGroupLayout(0),entries:s}),buffers:i})}updateTexture(e){this.renderPassDescriptor.colorAttachments[0].view=e}render(e){const t=e.beginRenderPass(this.renderPassDescriptor);t.setPipeline(this.pipeline),t.setBindGroup(0,this.bindGroup),t.draw(3),t.end()}updateEffectTextures(e){let t=0;for(const[r,i]of this.effects){const i=t===this.effects.size-1?e:this.getPingPongTexture(t%2!=0).createView();this.updateEffectTexture(r,i),t++}}updateEffectTexture(e,t){const r=this.effects.get(e);r&&(r.passDescriptor.colorAttachments[0].view=t)}renderEffects(e){for(const[t,r]of this.effects)this.applyEffect(t),this.renderEffect(t,e)}applyEffect(e){const t=this.effects.get(e);if(!t)return;const r=this.context.getDevice();for(const e of Object.keys(t.params))r.queue.writeBuffer(t.buffers[e],0,new Float32Array(t.params[e]))}renderEffect(e,t){const r=this.effects.get(e);if(!r)return;const i=t.beginRenderPass(r.passDescriptor);i.setPipeline(r.pipeline),i.setBindGroup(0,r.bindGroup),i.draw(3),i.end()}getPipeline(){return this.pipeline}getRenderTargetView(e){return this.renderTargetViews[e]}getRenderTargetFormat(){return this.renderTargetFormat}getRenderTargetsCount(){return this.renderTargetsCount}getPingPongTexture(e){return e?this.pingTarget:this.pongTarget}}},65304(e,t,r){r.d(t,{A:()=>i});const i=class{constructor(){this.program=null}setup(e,t,r){this.program=e.createShaderModule({label:t,code:r})}get(){return this.program}}},67998(e,t,r){r.d(t,{b:()=>i});class i{constructor(e){this.context=e,this.texture=null}createTextureFromSources(e,t){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};const i=t[0];this.texture=e.createTexture({format:"rgba8unorm",mipLevelCount:r.mips?this.numMipLevels(i.width,i.height):1,size:[i.width,i.height,t.length],usage:GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_DST|GPUTextureUsage.RENDER_ATTACHMENT}),this.copySourcesToTexture(e,this.texture,t,r)}numMipLevels(){const e=Math.max(...arguments);return 1+Math.log2(e)|0}copySourcesToTexture(e,t,r){let{flipY:i}=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};r.forEach(((r,s)=>{e.queue.copyExternalImageToTexture({source:r,flipY:i},{texture:t,origin:[0,0,s]},{width:r.width,height:r.height})}))}get(){return this.texture}getSampler(e){return e.createSampler({magFilter:"linear",minFilter:"linear",mipmapFilter:"linear"})}getView(){return this.texture.createView({dimension:"cube"})}createOne(e,t){const r=t[arguments.length>2&&void 0!==arguments[2]?arguments[2]:0],i=e.createTexture({size:[r.width,r.height],format:"rgba8unorm",usage:GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_DST|GPUTextureUsage.RENDER_ATTACHMENT});e.queue.copyExternalImageToTexture({source:r,flipY:!1},{texture:i,origin:[0,0,0]},{width:r.width,height:r.height}),this.texture=i}getViewOne(){return this.texture.createView()}}},69194(e,t,r){r.d(t,{A:()=>s});var i=r(54705);const s=class{constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:4;(0,i.A)(this,"resize",((e,t,r)=>{this.renderTarget.destroy(),this.depthTexture.destroy(),this.setup(e,t,r,this.depthTextureFormat)})),(0,i.A)(this,"setupRender",((e,t,r)=>{let{width:i,height:s}=r;this.renderTarget=e.createTexture({size:[i,s],sampleCount:this.sampleCount,format:t,usage:GPUTextureUsage.RENDER_ATTACHMENT}),this.renderTargetView=this.renderTarget.createView({label:"SceneTextureView"})})),(0,i.A)(this,"setupDepth",((e,t,r)=>{let{width:i,height:s}=r;this.depthTexture=e.createTexture({size:[i,s],sampleCount:this.sampleCount,format:t,usage:GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.TEXTURE_BINDING}),this.depthTextureView=this.depthTexture.createView({label:"SceneDepthTextureView"})})),(0,i.A)(this,"getRenderTargetView",(()=>this.renderTargetView)),(0,i.A)(this,"getDepthTextureView",(()=>this.depthTextureView)),(0,i.A)(this,"getDepthFormat",(()=>this.depthTextureFormat)),(0,i.A)(this,"getSampleCount",(()=>this.sampleCount)),this.renderTarget=null,this.renderTargetView=null,this.depthTexture=null,this.depthTextureView=null,this.sampleCount=e,this.depthTextureFormat="depth32float"}setup(e,t,r){let i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"depth32float";this.depthTextureFormat=i,this.setupRender(e,t,r),this.setupDepth(e,i,r)}}}}]);